version: 2.1
jobs:
  run-tests:
    description: Parameterized job by destination
    parameters:
      destination:
        description: Xcode destination to run tests
        type: string
    macos:
      xcode: '10.1.0'
    shell: /bin/bash --login -o pipefail
    steps:
      - checkout
      - run: gem install bundler
      - restore_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
      - run: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - restore_cache:
          key: 2-pods-{{ checksum "Example/Podfile.lock" }}
      - run:
          name: Install CocoaPods
          command: |
            ls -la Example/Pods/Manifest.lock && echo Skipping cocoapods repo update || curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
            cmp Example/Pods/Manifest.lock Example/Podfile.lock && echo Skipping pod install || bundle exec pod install --project-directory=Example
      - save_cache:
          key: 2-pods-{{ checksum "Example/Podfile.lock" }}
          paths:
            - Example/Pods
      - run:
          name: Build and run tests
          command: xcodebuild -workspace Example/PerspectiveTransform.xcworkspace -scheme Example test -destination "<< parameters.destination >>" | xcpretty -r junit
      - store_test_results:
          path: build/reports
      - store_artifacts:
          path: build/reports
          destination: xcodebuild-test-results
workflows:
  build:
    jobs:
      - run-tests:
          destination: 'platform=iOS Simulator,name=iPhone XS'
      - run-tests:
          destination: platform=iOS Simulator,name=iPhone X
      - run-tests:
          destination: platform=iOS Simulator,name=iPhone XR
      - run-tests:
          destination: platform=iOS Simulator,name=iPhone 8
      - run-tests:
          destination: platform=iOS Simulator,name=iPhone 8 Plus
      - run-tests:
          destination: platform=iOS Simulator,name=iPhone SE
